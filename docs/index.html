<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cookie Banner Configurator | smallest-cookie-banner</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      background: #fff;
      border-right: 1px solid #e0e0e0;
      padding: 20px;
      overflow-y: auto;
      max-height: 100vh;
      position: sticky;
      top: 0;
    }

    .sidebar h1 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .sidebar .subtitle {
      font-size: 12px;
      color: #666;
      margin-bottom: 20px;
    }

    .section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid #eee;
    }

    .section:last-child {
      border-bottom: none;
    }

    .section h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      margin-bottom: 12px;
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #333;
    }

    .field input[type="text"],
    .field input[type="number"],
    .field select,
    .field textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .field textarea {
      resize: vertical;
      min-height: 60px;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .color-field {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .color-field input[type="color"] {
      width: 36px;
      height: 36px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 2px;
      cursor: pointer;
    }

    .color-field input[type="text"] {
      flex: 1;
    }

    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-field input {
      width: 18px;
      height: 18px;
    }

    .checkbox-field label {
      margin: 0;
      font-weight: normal;
    }

    /* Preview area */
    .preview-area {
      padding: 20px;
      position: relative;
      min-height: 100vh;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .preview-header h2 {
      font-size: 16px;
    }

    .preview-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #2563eb;
      color: #fff;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #fff;
      border: 1px solid #ddd;
      color: #333;
    }

    .btn-secondary:hover {
      background: #f5f5f5;
    }

    /* Live Banner Preview */
    .banner-preview-container {
      background: #f0f0f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      min-height: 100px;
      display: flex;
      align-items: flex-end;
      position: relative;
    }

    .banner-preview-container h3 {
      position: absolute;
      top: 8px;
      left: 12px;
      font-size: 11px;
      text-transform: uppercase;
      color: #888;
      margin: 0;
    }

    .banner-preview {
      width: 100%;
      display: flex;
      align-items: center;
      gap: var(--preview-gap, 8px);
      padding: var(--preview-padding, 8px 12px);
      background: var(--preview-bg, #222);
      color: var(--preview-color, #fff);
      font: var(--preview-font, 14px system-ui, sans-serif);
      border-radius: var(--preview-radius, 0);
      flex-wrap: wrap;
    }

    .banner-preview p {
      margin: 0;
      flex: 1;
      min-width: 200px;
    }

    .banner-preview button {
      padding: var(--preview-btn-padding, 6px 12px);
      border: none;
      border-radius: var(--preview-btn-radius, 4px);
      background: var(--preview-btn-bg, #fff);
      color: var(--preview-btn-color, #222);
      font: inherit;
      cursor: pointer;
    }

    .banner-preview .reject-btn {
      background: transparent;
      color: inherit;
      border: 1px solid currentColor;
    }

    /* Code output */
    .code-output {
      margin-top: 20px;
      background: #1e1e1e;
      border-radius: 12px;
      overflow: hidden;
    }

    .code-header {
      background: #2d2d2d;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .code-header span {
      color: #888;
      font-size: 13px;
    }

    .code-header button {
      background: #3d3d3d;
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .code-header button:hover {
      background: #4d4d4d;
    }

    .code-body {
      padding: 16px;
      overflow-x: auto;
    }

    .code-body pre {
      margin: 0;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      color: #d4d4d4;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .code-body .comment { color: #6a9955; }
    .code-body .string { color: #ce9178; }
    .code-body .keyword { color: #569cd6; }
    .code-body .property { color: #9cdcfe; }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: -1px;
    }

    .tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: #666;
      font-size: 13px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
    }

    /* Demo status */
    .demo-status {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .demo-status.accepted {
      background: #dcfce7;
      border-color: #86efac;
    }

    .demo-status.rejected {
      background: #fee2e2;
      border-color: #fca5a5;
    }

    /* Countdown */
    #countdown {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #1e293b;
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 14px;
      z-index: 99999;
      display: none;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        max-height: none;
        position: relative;
      }
      .preview-content {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar Controls -->
    <div class="sidebar">
      <h1>Cookie Banner Configurator</h1>
      <p class="subtitle">Customize and generate your code</p>

      <!-- Text Content -->
      <div class="section">
        <h2>Text Content</h2>
        <div class="field">
          <label>Message</label>
          <textarea id="msg">We use cookies to enhance your experience.</textarea>
        </div>
        <div class="field-row">
          <div class="field">
            <label>Accept Button</label>
            <input type="text" id="acceptText" value="Accept">
          </div>
          <div class="field">
            <label>Reject Button</label>
            <input type="text" id="rejectText" value="Decline">
          </div>
        </div>
      </div>

      <!-- Behavior -->
      <div class="section">
        <h2>Behavior</h2>
        <div class="field">
          <label>Banner Mode</label>
          <select id="bannerMode">
            <option value="minimal">Minimal (simple accept/reject)</option>
            <option value="gdpr">GDPR (granular consent categories)</option>
          </select>
        </div>
        <div class="checkbox-field" style="margin-bottom:12px;">
          <input type="checkbox" id="enableTabs" checked>
          <label>Enable Tabbed UI (Consent/Details/About)</label>
        </div>
        <div class="field">
          <label>Region Mode</label>
          <select id="mode">
            <option value="auto">Auto-detect (EU vs non-EU)</option>
            <option value="eu">Force EU mode (always show reject)</option>
            <option value="non-eu">Force non-EU mode (auto-accept)</option>
          </select>
        </div>
        <div class="field">
          <label>Auto-accept delay (non-EU, ms)</label>
          <input type="number" id="autoAcceptDelay" value="5000" min="0" step="1000">
        </div>
        <div class="field">
          <label>Cookie expiry (days)</label>
          <input type="number" id="days" value="365" min="1">
        </div>
      </div>

      <!-- Position -->
      <div class="section">
        <h2>Position</h2>
        <div class="field">
          <label>Position</label>
          <select id="position">
            <option value="bottom">Bottom (full width)</option>
            <option value="top">Top (full width)</option>
            <option value="bottom-left">Bottom Left (toast)</option>
            <option value="bottom-right">Bottom Right (toast)</option>
            <option value="center">Center (modal)</option>
          </select>
        </div>
      </div>

      <!-- Colors -->
      <div class="section">
        <h2>Colors</h2>
        <div class="field">
          <label>Background</label>
          <div class="color-field">
            <input type="color" id="bgColor" value="#222222">
            <input type="text" id="bgColorText" value="#222222">
          </div>
        </div>
        <div class="field">
          <label>Text Color</label>
          <div class="color-field">
            <input type="color" id="textColor" value="#ffffff">
            <input type="text" id="textColorText" value="#ffffff">
          </div>
        </div>
        <div class="field">
          <label>Accept Button Background</label>
          <div class="color-field">
            <input type="color" id="btnBg" value="#ffffff">
            <input type="text" id="btnBgText" value="#ffffff">
          </div>
        </div>
        <div class="field">
          <label>Accept Button Text</label>
          <div class="color-field">
            <input type="color" id="btnColor" value="#222222">
            <input type="text" id="btnColorText" value="#222222">
          </div>
        </div>
      </div>

      <!-- Typography -->
      <div class="section">
        <h2>Typography</h2>
        <div class="field">
          <label>Font Family</label>
          <select id="fontFamily">
            <option value="system-ui, -apple-system, sans-serif">System (Default)</option>
            <option value="Arial, sans-serif">Arial</option>
            <option value="'Helvetica Neue', Helvetica, sans-serif">Helvetica</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="'Times New Roman', serif">Times New Roman</option>
            <option value="Monaco, 'Courier New', monospace">Monospace</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label>Font Size (px)</label>
            <input type="number" id="fontSize" value="14" min="10" max="24">
          </div>
          <div class="field">
            <label>Border Radius (px)</label>
            <input type="number" id="borderRadius" value="0" min="0" max="24">
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label>Padding (px)</label>
            <input type="number" id="padding" value="12" min="4" max="32">
          </div>
          <div class="field">
            <label>Button Radius (px)</label>
            <input type="number" id="btnRadius" value="4" min="0" max="24">
          </div>
        </div>
      </div>

      <!-- Widget -->
      <div class="section">
        <h2>Widget</h2>
        <div class="checkbox-field">
          <input type="checkbox" id="showWidget">
          <label>Show widget after consent</label>
        </div>
        <div class="field" id="widgetPositionField" style="display:none; margin-top:12px;">
          <label>Widget Position</label>
          <select id="widgetPosition">
            <option value="bottom-left">Bottom Left</option>
            <option value="bottom-right">Bottom Right</option>
          </select>
        </div>
      </div>

      <!-- Advanced -->
      <div class="section">
        <h2>Advanced</h2>
        <div class="field">
          <label>Z-Index</label>
          <input type="number" id="zIndex" value="9999" min="1">
        </div>
        <div class="checkbox-field" style="margin-bottom:12px;">
          <input type="checkbox" id="showCountdown" checked>
          <label>Show countdown (non-EU auto-accept)</label>
        </div>
        <div class="field">
          <label>Custom CSS (optional)</label>
          <textarea id="customCss" placeholder="#ckb { box-shadow: 0 0 20px rgba(0,0,0,0.2); }"></textarea>
        </div>
      </div>
    </div>

    <!-- Preview Area -->
    <div class="preview-area">
      <div id="countdown"></div>

      <div class="preview-header">
        <h2>Live Demo & Code</h2>
        <div class="preview-actions">
          <button class="btn btn-primary" onclick="launchDemo()">▶ Launch Demo</button>
          <button class="btn btn-secondary" onclick="resetDemo()">Reset</button>
          <button class="btn btn-secondary" onclick="copyCode()">Copy Code</button>
        </div>
      </div>

      <div id="demo-status" class="demo-status">
        <strong>Status:</strong> <span id="consent-status">Ready - click "Launch Demo"</span>
      </div>

      <!-- Live Banner Preview -->
      <div class="banner-preview-container" id="banner-preview-container">
        <h3>Live Preview</h3>
        <div class="banner-preview" id="banner-preview">
          <p id="preview-msg">We use cookies to enhance your experience.</p>
          <div id="preview-categories" style="display:none;width:100%;padding:12px 0;border-top:1px solid rgba(255,255,255,0.2);margin-top:8px;">
            <label style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;cursor:pointer;">
              <input type="checkbox" checked disabled style="width:18px;height:18px;">
              <div><div style="font-weight:600">Essential <span style="opacity:0.6;font-size:11px">(Required)</span></div><div style="font-size:12px;opacity:0.8">Required for the website to function</div></div>
            </label>
            <label style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;cursor:pointer;">
              <input type="checkbox" style="width:18px;height:18px;">
              <div><div style="font-weight:600">Analytics</div><div style="font-size:12px;opacity:0.8">Help us understand how visitors use our site</div></div>
            </label>
            <label style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;cursor:pointer;">
              <input type="checkbox" style="width:18px;height:18px;">
              <div><div style="font-weight:600">Marketing</div><div style="font-size:12px;opacity:0.8">Used to deliver relevant ads</div></div>
            </label>
          </div>
          <button class="settings-btn" id="preview-settings" style="display:none;background:transparent;color:inherit;border:1px solid currentColor;">Customize</button>
          <button class="reject-btn" id="preview-reject">Decline</button>
          <button id="preview-accept">Accept</button>
        </div>
      </div>

      <div class="code-output">
        <div class="code-header">
          <div class="tabs">
            <button class="tab active" onclick="showTab('html')">HTML</button>
            <button class="tab" onclick="showTab('css')">CSS Variables</button>
          </div>
          <button onclick="copyCode()">Copy</button>
        </div>
        <div class="code-body">
          <pre id="code-output"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Security: Escape functions for different contexts
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeJs(str) {
      return str
        .replace(/\\/g, '\\\\')
        .replace(/'/g, "\\'")
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/</g, '\\x3C')
        .replace(/>/g, '\\x3E');
    }

    function escapeCss(str) {
      // Remove dangerous CSS patterns
      return str
        .replace(/<[^>]*>/g, '') // Remove HTML tags
        .replace(/@\s*i\s*m\s*p\s*o\s*r\s*t\b[^;]*(;|$)/gi, '') // Remove @import
        .replace(/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\([^)]*\)/gi, '') // Remove expression()
        .replace(/javascript\s*:/gi, '') // Remove javascript:
        .replace(/behavior\s*:[^;]*(;|$)/gi, '') // Remove behavior:
        .replace(/-moz-binding\s*:[^;]*(;|$)/gi, ''); // Remove -moz-binding
    }

    // State
    let currentTab = 'html';

    // Get all input elements
    const inputs = {
      msg: document.getElementById('msg'),
      acceptText: document.getElementById('acceptText'),
      rejectText: document.getElementById('rejectText'),
      bannerMode: document.getElementById('bannerMode'),
      enableTabs: document.getElementById('enableTabs'),
      mode: document.getElementById('mode'),
      autoAcceptDelay: document.getElementById('autoAcceptDelay'),
      days: document.getElementById('days'),
      position: document.getElementById('position'),
      bgColor: document.getElementById('bgColor'),
      bgColorText: document.getElementById('bgColorText'),
      textColor: document.getElementById('textColor'),
      textColorText: document.getElementById('textColorText'),
      btnBg: document.getElementById('btnBg'),
      btnBgText: document.getElementById('btnBgText'),
      btnColor: document.getElementById('btnColor'),
      btnColorText: document.getElementById('btnColorText'),
      fontFamily: document.getElementById('fontFamily'),
      fontSize: document.getElementById('fontSize'),
      borderRadius: document.getElementById('borderRadius'),
      padding: document.getElementById('padding'),
      btnRadius: document.getElementById('btnRadius'),
      zIndex: document.getElementById('zIndex'),
      customCss: document.getElementById('customCss'),
    };

    // Sync color inputs
    ['bg', 'text', 'btnBg', 'btnColor'].forEach(prefix => {
      const colorInput = inputs[prefix + 'Color'];
      const textInput = inputs[prefix + 'ColorText'];

      colorInput.addEventListener('input', () => {
        textInput.value = colorInput.value;
        updatePreview();
      });

      textInput.addEventListener('input', () => {
        if (/^#[0-9a-f]{6}$/i.test(textInput.value)) {
          colorInput.value = textInput.value;
        }
        updatePreview();
      });
    });

    // Add event listeners to all inputs
    Object.values(inputs).forEach(input => {
      input.addEventListener('input', updatePreview);
      input.addEventListener('change', updatePreview);
    });

    // Get current config
    function getConfig() {
      return {
        msg: inputs.msg.value,
        acceptText: inputs.acceptText.value,
        rejectText: inputs.rejectText.value,
        bannerMode: inputs.bannerMode.value,
        enableTabs: inputs.enableTabs.checked,
        mode: inputs.mode.value,
        autoAcceptDelay: parseInt(inputs.autoAcceptDelay.value),
        days: parseInt(inputs.days.value),
        position: inputs.position.value,
        bgColor: inputs.bgColorText.value,
        textColor: inputs.textColorText.value,
        btnBg: inputs.btnBgText.value,
        btnColor: inputs.btnColorText.value,
        fontFamily: inputs.fontFamily.value,
        fontSize: parseInt(inputs.fontSize.value),
        borderRadius: parseInt(inputs.borderRadius.value),
        padding: parseInt(inputs.padding.value),
        btnRadius: parseInt(inputs.btnRadius.value),
        zIndex: parseInt(inputs.zIndex.value),
        customCss: inputs.customCss.value,
      };
    }

    // Generate position CSS
    function getPositionCSS(position) {
      const positions = {
        'bottom': '',
        'top': '--ckb-bottom: auto; --ckb-top: 0;',
        'bottom-left': '--ckb-right: auto; --ckb-left: 20px; --ckb-bottom: 20px;',
        'bottom-right': '--ckb-left: auto; --ckb-right: 20px; --ckb-bottom: 20px;',
        'center': '--ckb-bottom: auto; --ckb-top: 50%; --ckb-left: 50%; --ckb-right: auto;',
      };
      return positions[position] || '';
    }

    // Generate output code
    function generateOutputCode(config) {
      const forceEU = config.mode === 'eu' ? 'true' : config.mode === 'non-eu' ? 'false' : null;

      let positionVars = getPositionCSS(config.position);
      let extraCSS = '';

      if (config.position === 'bottom-left' || config.position === 'bottom-right') {
        extraCSS = `
#ckb {
  width: 340px;
  border-radius: ${config.borderRadius}px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  flex-direction: column;
}
#ckb p { min-width: auto; margin-bottom: 10px; }`;
      }

      if (config.position === 'center') {
        extraCSS = `
#ckb {
  width: 400px;
  border-radius: ${config.borderRadius}px;
  box-shadow: 0 4px 40px rgba(0,0,0,0.3);
  flex-direction: column;
  text-align: center;
  transform: translate(-50%, -50%);
}
#ckb p { min-width: auto; margin-bottom: 12px; }`;
      }

      if (currentTab === 'css') {
        // Sanitize values for CSS tab
        const cssBgColor = escapeHtml(config.bgColor);
        const cssTextColor = escapeHtml(config.textColor);
        const cssBtnBg = escapeHtml(config.btnBg);
        const cssBtnColor = escapeHtml(config.btnColor);
        const cssFontFamily = escapeHtml(config.fontFamily);
        const cssCustomCss = escapeCss(config.customCss);

        return `<span class="comment">/* Add to your CSS */</span>
<span class="keyword">:root</span> {
  <span class="property">--ckb-bg</span>: <span class="string">${cssBgColor}</span>;
  <span class="property">--ckb-color</span>: <span class="string">${cssTextColor}</span>;
  <span class="property">--ckb-btn-bg</span>: <span class="string">${cssBtnBg}</span>;
  <span class="property">--ckb-btn-color</span>: <span class="string">${cssBtnColor}</span>;
  <span class="property">--ckb-font</span>: <span class="string">${parseInt(config.fontSize)}px ${cssFontFamily}</span>;
  <span class="property">--ckb-padding</span>: <span class="string">${parseInt(config.padding)}px 16px</span>;
  <span class="property">--ckb-btn-radius</span>: <span class="string">${parseInt(config.btnRadius)}px</span>;
  <span class="property">--ckb-z</span>: <span class="string">${parseInt(config.zIndex)}</span>;${positionVars ? '\n  ' + positionVars.split(';').filter(s => s.trim()).join(';\n  ') + ';' : ''}
}${extraCSS}${cssCustomCss ? '\n\n' + cssCustomCss : ''}`;
      }

      // HTML tab - use proper escaping for all user inputs
      let configObj = [];
      if (config.bannerMode === 'gdpr') {
        configObj.push(`  mode: 'gdpr'`);
      }
      if (!config.enableTabs) {
        configObj.push(`  tabs: { enabled: false }`);
      }
      if (config.msg !== 'We use cookies to enhance your experience.') {
        configObj.push(`  msg: '${escapeJs(config.msg)}'`);
      }
      if (config.acceptText !== 'Accept') {
        configObj.push(`  acceptText: '${escapeJs(config.acceptText)}'`);
      }
      if (config.rejectText !== 'Decline') {
        configObj.push(`  rejectText: '${escapeJs(config.rejectText)}'`);
      }
      if (forceEU !== null) {
        configObj.push(`  forceEU: ${forceEU}`);
      }
      if (config.autoAcceptDelay !== 5000) {
        configObj.push(`  autoAcceptDelay: ${config.autoAcceptDelay}`);
      }
      if (config.days !== 365) {
        configObj.push(`  days: ${config.days}`);
      }

      // Sanitize CSS values for output
      const safeBgColor = escapeHtml(config.bgColor);
      const safeTextColor = escapeHtml(config.textColor);
      const safeBtnBg = escapeHtml(config.btnBg);
      const safeBtnColor = escapeHtml(config.btnColor);
      const safeFontFamily = escapeHtml(config.fontFamily);
      const safeCustomCss = escapeCss(config.customCss);

      let cssVars = `  --ckb-bg: ${safeBgColor};
  --ckb-color: ${safeTextColor};
  --ckb-btn-bg: ${safeBtnBg};
  --ckb-btn-color: ${safeBtnColor};
  --ckb-font: ${parseInt(config.fontSize)}px ${safeFontFamily};
  --ckb-padding: ${parseInt(config.padding)}px 16px;
  --ckb-btn-radius: ${parseInt(config.btnRadius)}px;
  --ckb-z: ${parseInt(config.zIndex)};${positionVars ? '\n  ' + positionVars.split(';').filter(s => s.trim()).join(';\n  ') + ';' : ''}`;

      // Always show config block with callbacks
      const configBlock = configObj.length > 0
        ? configObj.join(',\n') + ','
        : '';

      return `<span class="comment">&lt;!-- Add to &lt;head&gt; --&gt;</span>
<span class="keyword">&lt;style&gt;</span>
:root {
${cssVars}
}${extraCSS}${safeCustomCss ? '\n' + safeCustomCss : ''}
<span class="keyword">&lt;/style&gt;</span>

<span class="comment">&lt;!-- Add before &lt;/body&gt; --&gt;</span>
<span class="keyword">&lt;script&gt;</span>
window.CookieBannerConfig = {
${configBlock}${config.bannerMode === 'gdpr' ? `  onConsent: function(consent) {
    <span class="comment">// consent = { essential: true, analytics: true/false, marketing: true/false, functional: true/false }</span>
    if (consent.analytics) { <span class="comment">/* Load analytics */</span> }
    if (consent.marketing) { <span class="comment">/* Load marketing scripts */</span> }
  }` : `  onAccept: function() { <span class="comment">/* Load analytics */</span> },
  onReject: function() { <span class="comment">/* Respect choice */</span> }`}
};
<span class="keyword">&lt;/script&gt;</span>
<span class="keyword">&lt;script</span> <span class="property">src</span>=<span class="string">"https://unpkg.com/smallest-cookie-banner@latest/dist/cookie-banner.min.js"</span><span class="keyword">&gt;&lt;/script&gt;</span>`;
    }

    // Update code output
    function updatePreview() {
      const config = getConfig();

      // Update live banner preview
      const container = document.getElementById('banner-preview-container');

      container.style.setProperty('--preview-bg', config.bgColor);
      container.style.setProperty('--preview-color', config.textColor);
      container.style.setProperty('--preview-btn-bg', config.btnBg);
      container.style.setProperty('--preview-btn-color', config.btnColor);
      container.style.setProperty('--preview-font', `${config.fontSize}px ${config.fontFamily}`);
      container.style.setProperty('--preview-padding', `${config.padding}px 16px`);
      container.style.setProperty('--preview-gap', '8px');
      container.style.setProperty('--preview-btn-padding', '6px 12px');
      container.style.setProperty('--preview-btn-radius', `${config.btnRadius}px`);
      container.style.setProperty('--preview-radius', `${config.borderRadius}px`);

      // Update text content
      document.getElementById('preview-msg').textContent = config.msg;
      document.getElementById('preview-accept').textContent = config.acceptText;
      document.getElementById('preview-reject').textContent = config.rejectText;

      // Show/hide reject button based on mode
      const rejectBtn = document.getElementById('preview-reject');
      rejectBtn.style.display = config.mode === 'non-eu' ? 'none' : 'inline-block';

      // Show/hide GDPR elements based on banner mode
      const isGdpr = config.bannerMode === 'gdpr';
      document.getElementById('preview-categories').style.display = isGdpr ? 'block' : 'none';
      document.getElementById('preview-settings').style.display = isGdpr ? 'inline-block' : 'none';

      // Update button text for GDPR mode
      if (isGdpr) {
        document.getElementById('preview-accept').textContent = 'Accept All';
        if (config.mode !== 'non-eu') {
          document.getElementById('preview-reject').textContent = 'Reject All';
        }
      } else {
        document.getElementById('preview-accept').textContent = config.acceptText;
        document.getElementById('preview-reject').textContent = config.rejectText;
      }

      // Update code output
      document.getElementById('code-output').innerHTML = generateOutputCode(config);
    }

    // Show tab
    function showTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
      document.getElementById('code-output').innerHTML = generateOutputCode(getConfig());
    }

    // Copy code with fallback
    function copyCode() {
      const config = getConfig();
      let code = generateOutputCode(config)
        .replace(/<span class="[^"]*">/g, '')
        .replace(/<\/span>/g, '')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>');

      const showSuccess = () => {
        const btn = document.querySelector('.code-header button');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy', 2000);
      };

      // Try modern clipboard API first, fallback to execCommand
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(code).then(showSuccess).catch(() => {
          // Fallback for older browsers or non-HTTPS
          fallbackCopy(code, showSuccess);
        });
      } else {
        fallbackCopy(code, showSuccess);
      }
    }

    function fallbackCopy(text, onSuccess) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        onSuccess();
      } catch (err) {
        console.error('Copy failed:', err);
      }
      document.body.removeChild(textarea);
    }

    // Widget toggle
    document.getElementById('showWidget').addEventListener('change', function() {
      document.getElementById('widgetPositionField').style.display = this.checked ? 'block' : 'none';
      updatePreview();
    });

    // Initial render
    updatePreview();
  </script>

  <!-- Load the actual cookie banner library -->
  <script src="cookie-banner.js"></script>

  <script>
    // Demo functionality
    let currentBanner = null;
    let countdownInterval = null;
    const countdownEl = document.getElementById('countdown');

    function clearCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      countdownEl.style.display = 'none';
    }

    function startCountdown(ms) {
      clearCountdown();
      if (!document.getElementById('showCountdown').checked) return;

      let remaining = ms;
      countdownEl.style.display = 'block';

      function tick() {
        countdownEl.textContent = 'Auto-accept: ' + (remaining / 1000).toFixed(1) + 's';
        remaining -= 100;
        if (remaining < 0) clearCountdown();
      }
      tick();
      countdownInterval = setInterval(tick, 100);
    }

    function updateConsentStatus(status) {
      const statusEl = document.getElementById('demo-status');
      const textEl = document.getElementById('consent-status');

      statusEl.classList.remove('accepted', 'rejected');

      if (status === true) {
        statusEl.classList.add('accepted');
        textEl.textContent = '✅ Accepted';
      } else if (status === false) {
        statusEl.classList.add('rejected');
        textEl.textContent = '❌ Rejected';
      } else {
        textEl.textContent = '⏳ Pending';
      }
    }

    function getDemoConfig() {
      const config = getConfig();
      const forceEU = config.mode === 'eu' ? true : config.mode === 'non-eu' ? false : undefined;

      const isToast = ['bottom-left', 'bottom-right', 'center'].includes(config.position);
      const demoConfig = {
        mode: config.bannerMode,
        tabs: { enabled: config.enableTabs, toast: isToast },
        forceEU: forceEU,
        autoAcceptDelay: config.autoAcceptDelay,
        msg: config.msg,
        acceptText: config.bannerMode === 'gdpr' ? 'Accept All' : config.acceptText,
        rejectText: config.bannerMode === 'gdpr' ? 'Reject All' : config.rejectText,
        days: config.days,
        onAccept: function() {
          clearCountdown();
          updateConsentStatus(true);
        },
        onReject: function() {
          clearCountdown();
          updateConsentStatus(false);
        },
        onConsent: function(state) {
          clearCountdown();
          updateConsentStatus(true);
          console.log('Consent:', state);
        }
      };

      // Add widget config
      if (document.getElementById('showWidget').checked) {
        demoConfig.widget = {
          enabled: true,
          position: document.getElementById('widgetPosition').value
        };
      }

      // Build CSS for Shadow DOM (external styles don't work)
      let css = '';
      css += `#ckb{--ckb-bg:${config.bgColor};--ckb-color:${config.textColor};--ckb-btn-bg:${config.btnBg};--ckb-btn-color:${config.btnColor};--ckb-font:${config.fontSize}px ${config.fontFamily};--ckb-padding:${config.padding}px 16px;--ckb-btn-radius:${config.btnRadius}px;--ckb-z:${config.zIndex};}`;

      // Position CSS
      if (config.position === 'top') {
        css += '#ckb{bottom:auto;top:0;}';
      } else if (config.position === 'bottom-left') {
        css += '#ckb{right:auto;left:20px;bottom:20px;width:340px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);}#ckb p{min-width:auto;}';
      } else if (config.position === 'bottom-right') {
        css += '#ckb{left:auto;right:20px;bottom:20px;width:340px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);}#ckb p{min-width:auto;}';
      } else if (config.position === 'center') {
        css += '#ckb{bottom:auto;top:50%;left:50%;right:auto;width:400px;border-radius:12px;box-shadow:0 4px 40px rgba(0,0,0,0.3);transform:translate(-50%,-50%);}#ckb p{min-width:auto;}';
      }

      if (config.customCss) {
        css += config.customCss;
      }

      demoConfig.css = css;

      return demoConfig;
    }

    function launchDemo() {
      resetDemo();

      const config = getDemoConfig();
      console.log('Launching demo with config:', config);

      // Create and show banner (CSS is passed via config.css for Shadow DOM)
      if (typeof window.createCookieBanner === 'function') {
        currentBanner = window.createCookieBanner(config);
        currentBanner.show();

        updateConsentStatus(null);

        // Start countdown for non-EU
        const isNonEU = config.forceEU === false ||
          (config.forceEU === undefined && window.CookieBannerModule && !window.CookieBannerModule.isEU());
        if (isNonEU && config.autoAcceptDelay > 0) {
          startCountdown(config.autoAcceptDelay);
        }
      } else {
        alert('Library not loaded! Make sure dist/cookie-banner.js exists.');
      }
    }

    function resetDemo() {
      clearCountdown();

      // Clear cookies
      document.cookie.split(';').forEach(c => {
        const name = c.trim().split('=')[0];
        if (name) document.cookie = name + '=;expires=Thu,01 Jan 1970 00:00:00 GMT;path=/';
      });

      // Destroy current banner
      if (currentBanner) {
        currentBanner.destroy();
        currentBanner = null;
      }

      // Clean up DOM (v2.0 uses web components)
      document.querySelectorAll('cookie-banner-element, #ckb, [id^="ckb-widget"]').forEach(el => el.remove());
      document.querySelectorAll('style[id^="ckb-style"]').forEach(s => s.remove());

      window.CookieBanner = undefined;

      document.getElementById('consent-status').textContent = 'Ready - click "Launch Demo"';
      document.getElementById('demo-status').classList.remove('accepted', 'rejected');
    }

    // Check if library loaded
    if (typeof window.createCookieBanner === 'function') {
      console.log('Cookie banner library loaded successfully');
    } else {
      console.warn('Cookie banner library not loaded');
    }
  </script>
</body>
</html>
